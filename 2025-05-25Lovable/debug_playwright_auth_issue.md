# Playwrightテストにおける認証フローの不具合調査依頼

## 1. 現状のサマリー

Playwrightで実施しているE2Eテストにおいて、ユーザー認証フロー（新規ユーザー登録、ログイン・ログアウト）およびメール送信機能に関連するテストが失敗しています。
特に、**ログイン処理後、期待される管理画面ページへ遷移せず、認証ページへリダイレクトされてしまう**という問題が継続して発生しています。

Supabaseの「メールアドレスの確認」オプションは既に無効化済みですが、問題は解決していません。

## 2. テスト環境と主要ツール

-   **テストフレームワーク:** Playwright
-   **バックエンド/認証:** Supabase
-   **詳細なテスト結果:** `playwright-report/index.html` （特にTrace Viewerの情報が重要です）

## 3. 確認されている主な問題点

-   **ログインフローの失敗:**
    -   ユーザー認証情報を入力しログインを実行すると、管理画面等へ遷移する代わりに認証ページへ戻されます。
    -   セッションが正しく確立・維持されていない可能性があります。
-   **新規ユーザー登録フローの失敗:** (関連する可能性あり)
    -   登録処理が完了しない、または登録後に同様のログイン問題が発生する可能性があります。
-   **メール送信機能の失敗:** (認証問題に起因する可能性あり)
    -   お問い合わせフォームなどのメール送信が機能していません。

## 4. 考えられる原因と調査すべきコード箇所

これまでの分析から、以下の領域に問題の原因が存在する可能性が高いと考えられます。`playwright-report/index.html` の詳細なトレース情報と合わせて、実際のコードベースの以下の箇所を重点的に確認してください。

### 4.1. クライアントサイド (フロントエンドアプリケーションコード)

-   **認証トークン管理 (Auth Service / API Client):**
    -   **該当コード:** Supabaseクライアント (`supabase-js`) を使用してログイン処理、トークン取得・保存・読み込みを行っている箇所。通常、`authService.js`, `apiClient.js`, `useAuth.js` といったファイルや、関連するReactコンポーネント/Vueコンポーネント/Svelteコンポーネント内に存在します。
    -   **確認ポイント:**
        -   ログイン成功時にSupabaseから返されるアクセストークン (`access_token`) とリフレッシュトークン (`refresh_token`) が、`localStorage`、`sessionStorage`、またはCookieに正しく保存されているか。
        -   保存されたトークンが、その後の保護されたAPIリクエストのヘッダー (`Authorization: Bearer <token>`) に適切に付与されているか。
        -   トークンの有効期限切れやリフレッシュ処理に問題がないか。
        -   Supabaseクライアントの初期化設定（`SUPABASE_URL`, `SUPABASE_ANON_KEY`）が正しいか。
-   **ルーティングとルートガード (Routing Logic):**
    -   **該当コード:** React Router, Next.js Router, Vue Routerなどのルーティングライブラリを使用している場合、ルート定義ファイルや、認証状態に基づいてアクセス制御を行う「ルートガード」または「プライベートルート」コンポーネント。
    -   **確認ポイント:**
        -   ユーザーの認証状態をチェックするロジックが正確か。
        -   認証済みユーザーがアクセスすべきページ（例：`/dashboard`）から、意図せず認証ページ（例：`/login`, `/auth`）へリダイレクトする条件がないか。
        -   非同期で認証状態を取得している場合、その完了を待たずにリダイレクト判定が行われていないか。
-   **状態管理 (State Management):**
    -   **該当コード:** Redux, Zustand, Vuex, React Context APIなどでユーザーの認証状態 (`isAuthenticated`, `user` など) を管理している箇所。
    -   **確認ポイント:**
        -   ログイン成功時に、グローバルな認証状態が正しく `true` またはユーザー情報で更新されているか。
        -   ページ遷移やコンポーネントの再レンダリング時に、この状態が予期せずリセットされていないか。

### 4.2. サーバーサイド (Supabase設定 / バックエンドロジック)

-   **Supabase Row Level Security (RLS) ポリシー:**
    -   **確認箇所:** Supabaseプロジェクトの管理画面 > Authentication > Policies, および各テーブルのRLS設定。
    -   **確認ポイント:**
        -   ログインしたユーザーが、管理画面表示に必要なデータやその他のリソースにアクセスするためのSELECT権限などがRLSポリシーで適切に許可されているか。
        -   `auth.uid()` や `auth.role()` を使ったポリシーの条件が正しいか。
-   **Supabase API 設定 / カスタム関数:**
    -   **確認箇所:** もしカスタムのEdge FunctionsやDatabase Functionsを認証フローやセッション管理で利用している場合、それらのコード。
    -   **確認ポイント:**
        -   トークン検証ロジック（もしあれば）が正しく機能しているか。
        -   カスタム関数内でエラーが発生していないか (Supabaseプロジェクトのログを確認)。

### 4.3. Playwrightテストスクリプト自体

-   **非同期処理の待機不足:**
    -   **該当コード:** `*.spec.ts` や `*.test.js` といったPlaywrightのテストファイル。
    -   **確認ポイント:**
        -   ログイン処理後、ページ遷移やDOM要素の出現を待つための `await page.waitForNavigation()`, `await page.waitForURL()`, `await page.waitForSelector()` などが適切かつ十分な時間で設定されているか。
        -   特に、リダイレクトが複数回発生する場合や、バックグラウンドでAPIコールが行われた後にUIが更新される場合など、明示的な待機が必要なケースを見落としていないか。
-   **テスト環境のクリーンアップ / セットアップ:**
    -   **該当コード:** `beforeEach`, `afterEach` フックや、テストのヘルパー関数。
    -   **確認ポイント:**
        -   各テストの開始前に、`localStorage` や `sessionStorage`、Cookieがクリアされているか、またはテストに必要な初期状態が正しくセットアップされているか（`globalSetup` など）。

## 5. 依頼事項

1.  **`playwright-report/index.html` の詳細分析:**
    -   特にTrace Viewerを使用して、ログイン試行からリダイレクト発生までのネットワークリクエスト、コンソールログ、DOMの状態変化を詳細に追跡してください。
    -   どのAPIコールが失敗しているか、または予期せぬレスポンスを返しているか。
    -   コンソールにエラーメッセージや警告が出力されていないか。
2.  **上記「4. 考えられる原因と調査すべきコード箇所」に記載された関連コードのレビュー:**
    -   フロントエンドのトークン管理、ルーティング、状態管理ロジック。
    -   SupabaseのRLSポリシーや関連設定。
    -   Playwrightのテストスクリプトにおける待機処理やテスト間の分離。
3.  **具体的な修正案の提示:**
    -   特定された問題箇所に対する具体的なコード修正案や設定変更案を提示してください。
    -   追加で必要となるデバッグ手順やログ取得方法があれば、それも合わせてご教示ください。

ご協力のほど、よろしくお願いいたします。 