# Playwright操作感テスト結果に基づく改善提案依頼

## 1. はじめに

このドキュメントは、ピアノ教室検索サイトのPlaywrightによる操作感テストで確認された問題点について、改善提案をいただくことを目的としています。現状のコードベースやスクリプトを踏まえ、より正確で効果的な実装方針についてご意見を伺いたいです。

## 2. テスト対象サイト概要

-   **URL**: `https://0abff097.piano-rythmique.pages.dev/`
-   **技術スタック**: (フロントエンド: Nuxt.js/Vue.js, バックエンド: Supabase を利用していると推測されますが、詳細は不明です)
-   **目的**: 全国のピアノ教室やリトミック教室を検索できるプラットフォーム

## 3. Playwrightテストで確認された主な問題点

以下に、Playwrightを用いた操作テスト中に確認された主な問題点を記載します。現状の報告はテスト中の観測に基づいたものであり、必ずしも全ての原因を特定できているわけではない点をご留意ください。

### 3.1. 一般ユーザーフローにおける教室検索機能

#### 3.1.1. キーワード検索で結果が0件になる問題

-   **発生手順**:
    1.  トップページ (`/`) のキーワード検索欄に「東京都」と入力。
    2.  「検索」ボタンをクリック。
    3.  `/search?keyword=東京都` に遷移。
-   **観測された現象**: 検索結果が0件と表示される。
-   **期待される動作**: 「東京都」に関連する教室が検索結果として表示される。
-   **関連スクリーンショット**: (該当するテスト実行時のスクリーンショットがあれば、そのファイル名を記載してください。例: `keyword_search_no_results.png`)

#### 3.1.2. 「ピアノ教室を探す」ボタンクリック後、検索結果がすぐに0件になる問題

-   **発生手順**:
    1.  トップページ (`/`) の「ピアノ教室を探す」ボタン（`href="/search?type=piano"`）をクリック。
    2.  `/search?type=piano` に遷移。
-   **観測された現象**: 一瞬、教室一覧らしきものが表示されるが、すぐに「検索結果0件です」という表示に切り替わる。
-   **期待される動作**: ピアノ教室の一覧が正しく表示され、維持される。
-   **関連スクリーンショット**: (該当するテスト実行時のスクリーンショットがあれば、そのファイル名を記載してください。例: `type_search_results_disappear.png`)

### 3.2. 教室運営者フローにおける管理画面へのナビゲーション

#### 3.2.1. ログイン後の「管理画面」リンククリックの不安定さ

**再現手順:**

1.  Playwrightテストスクリプトで、既存の教室運営者アカウントを使用してログイン処理を実行する。
2.  ログイン成功後、トップページ (`/`) にリダイレクトされる。ヘッダーには「管理画面」「ログアウト」などのリンクが表示される。
3.  ヘッダーの「管理画面」リンクをクリックしようとする。

**発生した問題:**

-   ステップ3のリンククリックが、`TimeoutError` (例: `waiting for locator('a:has-text("管理画面")')`) となり頻繁に失敗した。
-   開発者ツールで確認すると要素は存在し、`href="/dashboard"` も正しい。
-   最終的に、`a:has-text('管理画面')` というテキストベースのセレクターでも失敗が続き、ページを再読み込みしたり、URL直接アクセス (`/dashboard`) を試みた。

**期待される動作と現状のギャップ:**

-   **期待される動作**: ログイン後、ヘッダーに表示される「管理画面」リンクを安定してクリックでき、管理画面ページ (`/dashboard` TODO: パスも変更検討) に遷移できる。
-   **現状**: リンククリックが不安定でテストが頻繁に失敗する。

**具体的な質問:**

*   「3.2.1. ログイン後の「管理画面」リンククリックの不安定さ」について、要素のレンダリングタイミング、イベント発火の遅延、他のUI要素による妨害など、考えられる原因は何でしょうか？ Playwright の Trace Viewer を見ても、クリック試行時には要素が見えているように思えますが、なぜタイムアウトするのでしょうか？
*   `page.waitForLoadState('networkidle')` や `page.waitForSelector` を入れても改善しませんでした。他に試すべき Playwright の待機方法はありますか？
*   「管理画面」リンクのようにクリックが不安定な要素に対して、Playwright側でより確実に対象を特定し操作するためのテクニック（待機処理の工夫、セレクターの代替案など）があれば教えてください。

**試したセレクターと結果:**

-   成功したセレクター（URL直接アクセスなど）: `await page.goto('/dashboard');` (TODO: パスも変更検討)
-   失敗または不安定だったセレクター（「管理画面」リンク関連）: `a[data-testid='header-classrooms-link']`, `a[href='/dashboard']` (TODO: パスも変更検討), `header div a[href='/dashboard']` (TODO: パスも変更検討), `a:has-text('管理画面')`

## 4. 問い合わせ事項

上記の現象を踏まえ、以下の点についてご意見・ご提案をいただけますでしょうか。

1.  **原因分析**:
    *   「3.1.1. キーワード検索で結果が0件になる問題」について、フロントエンド、バックエンド（API、データベースクエリ等）のどちらに原因がある可能性が高いと考えられますか？また、どのような点が調査ポイントとなりますか？
    *   「3.1.2. 「ピアノ教室を探す」ボタンクリック後、検索結果がすぐに0件になる問題」について、状態管理（例: Vuex/Pinia）、データの非同期取得、フィルタリングロジック等、どの部分に問題が潜んでいる可能性が高いでしょうか？
    *   「3.2.1. ログイン後の「管理画面」リンククリックの不安定さ」について、要素のレンダリングタイミング、イベント発火の遅延、他のUI要素による妨害など、考えられる原因は何でしょうか？

2.  **具体的な修正アプローチ**:
    *   上記各問題に対して、具体的な修正方針やコード例（Nuxt.js/Vue.js, Supabaseを想定）があればご教示ください。
    *   特に、検索結果が0件になる問題については、APIリクエスト・レスポンスの確認方法や、デバッグのポイントなども含めてアドバイスいただけると幸いです。

3.  **テストの安定性向上**:
    *   Playwrightテストの安定性を高めるために、`data-testid` 属性を付与する戦略についてアドバイスをお願いします（どのような要素に、どのような命名規則で付与するのが効果的か等）。
    *   「管理画面」リンクのようにクリックが不安定な要素に対して、Playwright側でより確実に対象を特定し操作するためのテクニック（待機処理の工夫、セレクターの代替案など）があれば教えてください。

4.  **その他**:
    *   今回のテスト結果や観察された現象から、他にコードベース全体で改善が推奨される点や、注意すべきアンチパターンなどがあればご指摘ください。

## 5. 補足情報 (Playwrightテスト関連)

-   **主な使用セレクター（例）**:
    -   成功例: `input[data-testid='login-email']`, `button:has-text('ログアウト')`, `div[data-state="active"] a[href="/classroom/register"]:has-text('教室情報を編集')`
    -   失敗または不安定だったセレクター（「管理画面」リンク関連）: `a[data-testid='header-classrooms-link']`, `a[href='/dashboard']`, `header div a[href='/dashboard']`, `a:has-text('管理画面')`
-   **関連する可能性のあるファイル**:
    -   （過去の調査で `supabase/functions/customer-portal/index.ts` やフロントエンドの `useSubscription.tsx` などが関連していました。今回の問題に直接関連するかは不明です。）
-   **テスト実行環境**:
    -   OS: macOS (darwin 24.2.0)
    -   Playwright (バージョン情報はテスト実行者に確認が必要)

## 6. おわりに

貴重なお時間をいただき恐縮ですが、本サイトの品質向上のため、専門的な知見からのアドバイスをいただけますと幸いです。よろしくお願いいたします。 